---
title: "B4BI Pak Choi data cleaning and preprocessing"
author: "Heather Jenkins"
date: "`r format(Sys.time(), '%d %B %Y')`"
output:
  html_document: 
    toc: true  
    toc_depth: 3  
    toc_float: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(fig.width=6, fig.height=4.5, dpi=600, warning=FALSE, message=FALSE, echo=TRUE)
options(scipen=999)
library(tidyverse)
library(readxl)
library(janitor)
library(kableExtra)
```


# Overview

The script contains data checking and tidying of the Pak Choi seed and pollinator datasets.

This was performed using  `r version$version.string`. The *tidyverse* suite of packages was used.

# Seed data

## Data with replicates

The 'main' file is

+ "Copy of B4BI_Pak-choi_seed_data_for_Heather (BH edit).xlsx"  

This updated file has a new column 'Native_new_age', and also a bunch of farms with 'Control_farm = Simplified_Boundary' have been fixed (previously, these were mislabeled as 'Bare_fence' and the fix was done with code).

The following file is used to add the Type_of_farm column (Arable or Dairy):

+ "Farm type and treatment for pak choi Heather update.xlsx"   

The data is read in, and some of the columns are removed or renamed. The garden data is also removed on Brad's instruction.

```{r}
pc <- read_excel("Excel_files_from_Brad/Copy of B4BI_Pak_choi_seed_data_for_Heather (BH edit).xlsx") %>% 
  # mutate(Simplified_Boundary=case_when(
  #   Farm=="Ahuriri" & Simplified_Boundary=="Bare_fence" ~ "Control_farm",
  #   Farm=="Ashford_1" & Simplified_Boundary=="Bare_fence" ~ "Control_farm", 
  #   Farm=="FAR" & Simplified_Boundary=="Bare_fence" ~ "Control_farm",
  #   Farm=="Limbrick" & Simplified_Boundary=="Bare_fence" ~ "Control_farm",
  #   Farm=="Nutpoint" & Simplified_Boundary=="Bare_fence" ~ "Control_farm",
  #   TRUE ~ Simplified_Boundary
  # )) %>%
  mutate(Year=factor(Year), 
         Farm=factor(Farm),
         Property_Grouping=factor(Property_Grouping),
         PK_Boundary=factor(PK_Boundary),
         Simplified_Boundary=factor(Simplified_Boundary),
         Very_Simplified_Boundary=factor(Very_Simplified_Boundary),
         Treatment=factor(Treatment),
         Native_new_age=factor(Native_new_age)) %>%
  dplyr::select(-`Number...1`, -Surveyblock, -Survey_Date, -Survey_Date_Text, -Seed_count_date) %>%
  rename(Rep=`Number...15`, Number_of_Pods=`Number pods`, Pod_number=`Pod #`) %>%
  filter(!is.na(`Seed viable`)) %>%
  droplevels() %>%
  mutate(Treatment=fct_relevel(Treatment, "HP", "Open")) %>% 
  mutate(Treatment=fct_recode(Treatment, 
                            "Hand pollinated"="HP")) %>%
  mutate(Simplified_Boundary=fct_recode(Simplified_Boundary,
                                        "Old native"="Old_Native",
                                        "New native"="New_Native",
                                        "Bare fence"="Bare_fence",
                                        "Control farm"="Control_farm"),
         Native_new_age=fct_recode(Native_new_age,
                                   "Old native"="Old",
                                   "One-year old native"="one year native",
                                   "Two-year old native"="two year native",
                                   "Three-year old native"="three year native",
                                   "On-farm bare fence"="On-farm bare",
                                   "Off-farm bare fence"="Off-farm bare"
                                   )) %>%
  mutate(Simplified_Boundary=fct_relevel(Simplified_Boundary,
                                        "Old native",
                                        "New native",
                                        "Bare fence",
                                        "Control farm"
                                        ),
         Native_new_age=fct_relevel(Native_new_age,
                                   "Old native",
                                   "Three-year old native",
                                   "Two-year old native",
                                   "One-year old native",
                                   "On-farm bare fence",
                                   "Off-farm bare fence",
                                    "Garden"
                                    )) %>%
  mutate(Farm=fct_recode(Farm,
                         "Ashford 1"="Ashford_1",
                        "Lochan Mor"="Lochan_Mor",
                        "Te Maania"="Te_maania",
                        "Terrace View"="Terrace_view")) %>%
  mutate(Year=fct_recode(Year, "2021-2022"="2021_2022", "2022-2023"="2022_2023", "2023-2024"="2023_2024")) 


dairy_arable <- read_excel("Excel_files_from_Brad/Farm type and treatment for pak choi Heather update.xlsx", sheet="Sheet1", range="A3:C57") %>%
  mutate(Farm=str_replace(Farm, "Te_maania", "Te_Maania")) %>%
  mutate(Farm=str_replace(Farm, "Terrace_view", "Terrace_View")) %>%
  mutate(Farm=factor(str_replace(Farm, "_", " ")), Simplified_Boundary=factor(str_replace(Simplified_Boundary, "_", " ")),
         Type_of_farm=factor(Type_of_farm)) %>%
  mutate(Simplified_Boundary=fct_recode(Simplified_Boundary,
                                        "Old native"="Old Native",
                                        "New native"="New Native"
                                   )) %>%
  mutate(Simplified_Boundary=fct_relevel(Simplified_Boundary,
                                        "Old native",
                                        "New native",
                                        "Bare fence",
                                        "Control farm"))

# table(dairy_arable$Farm, dairy_arable$Simplified_Boundary)

pc <- pc %>% left_join(dairy_arable, by=c("Farm", "Simplified_Boundary")) %>%
  filter(Simplified_Boundary!="Garden") %>% droplevels()

rm(dairy_arable)
str(pc)
```

This data is saved.

```{r}
save(pc, file="Cleaned_datasets/pc_seed_data_cleaned.rda")
write_csv(pc, file="Cleaned_datasets/pc_seed_data_cleaned.csv")
# table(pc$Farm, pc$Number_of_Pods)
# table(pc$Farm, pc$Pod_number)
# table(pc$Number_of_Pods, pc$Pod_number)
```

## Summarised data

+ The data is grouped by Year, Farm, Type_of_farm, Simplified_Boundary, Native_new_age, Treatment, Rep.     
+ The mean of the `Seed viable` is taken. This is the mean across all the pods for each rep. Note the number of pods for each Rep was quite variable.  
+ Then the data is grouped by Year, Farm, Type_of_farm, Simplified_Boundary, Native_new_age, Treatment.  
+ The mean seeds viable is calculated, so we get a mean over the Reps.  
+ For each Year, Farm and Simplified_Boundary combination we have a mean seed counts for each treatment where each rep has the same weight in the mean.  
+ If we didn't do the means with the two group_by steps then each pod would have the same weight in the mean.  

```{r}
pc_sum <- pc %>% 
  group_by(Year, Farm, Type_of_farm, Simplified_Boundary, Native_new_age, Treatment, Rep) %>% 
  summarise(Mean_seeds_viable=mean(`Seed viable`)) %>%
  group_by(Year, Farm, Type_of_farm, Simplified_Boundary, Native_new_age, Treatment) %>% 
  summarise(Mean_seeds_viable=mean(Mean_seeds_viable)) %>%
  ungroup()

str(pc_sum)
```

This data is saved.

```{r}
save(pc_sum, file="Cleaned_datasets/pc_seed_data_summarised_cleaned.rda")
write_csv(pc_sum, file="Cleaned_datasets/pc_seed_data_summarised_cleaned.csv")
```

# Pollinator data

This data is in the file 

+ "Pak choi pollinators raw visits Brad correctedupdatedHeatherxlsx (002).xlsx"  

The data is read in.

```{r}
pc_pol <- read_excel("Excel_files_from_Brad/Pak choi pollinators raw visits Brad correctedupdatedHeatherxlsx (002).xlsx", 
                 sheet="Pak choi raw visits", 
                 col_types = c("text", "text", "text", "text", "numeric", 
                               "numeric", "text", "numeric", "text", "text")) %>%
  clean_names() %>%
  rename(new_insect_key_name=new_inseck_key_name) %>%
  mutate(farm_type=factor(farm_type), 
         farm_name=factor(farm_name), 
         season=factor(season), 
         boundary_descriptor=factor(boundary_descriptor),
         insect_key_number=factor(insect_key_number),
         new_insect_key_name=factor(new_insect_key_name),
         broad_insect_category=factor(broad_insect_category),
         origin=factor(origin)) %>%
  mutate(boundary_descriptor=fct_recode(boundary_descriptor, 
                                        `Control farm`= "Control_farm",
                                        `Bare fence` = "Bare_fence",
                                        "One year old" = "one year old",
                                        "Two year old" = "two year old",
                                        "Three year old" ="three year old" 
                                        )) %>%
  mutate(boundary_descriptor=fct_relevel(boundary_descriptor, "Control farm", "Bare fence", "Old", "One year old", "Two year old" ))

str(pc_pol)
```

When the data is grouped by new_insect_key_name and summarised by taking the mean of sum_of_insects_100_flowers, there are nine insects where the
mean is zero which means those insects were not observed at all. We can't model
those counts as there is no variability. They are removed from the data. These insects are:

```{r}
pc_pol_sum <- pc_pol %>% group_by(new_insect_key_name) %>% 
  summarise(Mean_count_per_100_flowers=mean(sum_of_insects_100_flowers))# %>% ungroup()

remove_insects <- pc_pol_sum %>% filter(Mean_count_per_100_flowers==0) %>% dplyr::select(new_insect_key_name) %>% remove_rownames() 
remove_insects <- remove_insects$new_insect_key_name %>% as.vector()

data.frame("Insects not observed at all" = remove_insects) %>%
  kable(format = "pandoc")
```

```{r}
pc_pol <- pc_pol %>% filter(!(new_insect_key_name %in% remove_insects)) %>% droplevels()
rm(remove_insects, pc_pol_sum)
```

There are some farms with double observations in a season (for the old boundary
descriptor). These are due to the inclusion of two separate planting years: 2017
and 2018. A separate column titled “Boundary Age” was added to the data to
distinguish between these. *Per Brad's instructions, the 2018 planting are excluded.*

There is an observation with "Honey bee" in the "Wild bees" broad insect category. This is a zero in the data, and it is fixed.

We create an alternative boundary descriptor, boundary_alt, where there are less
categories. The 'One year old', 'Two year old' and 'Three year old' are grouped
together as 'New'. The other categories are the same.

```{r}
pc_pol <- pc_pol %>% filter(is.na(boundary_age) | boundary_age == 2017 ) %>% 
  mutate(broad_insect_category=as.character(broad_insect_category)) %>%
  mutate(broad_insect_category=factor(
    ifelse(new_insect_key_name=="Honey bee" & broad_insect_category=="Wild bees", 
           "Honey bees", broad_insect_category))) %>%
  mutate(origin=fct_relevel(origin, "Native")) %>%
  mutate(boundary_descriptor=as.character(boundary_descriptor)) %>%
  mutate(boundary_alt=factor(ifelse(str_ends(boundary_descriptor, "old"), "New", boundary_descriptor))) %>%
  mutate(boundary_descriptor=factor(boundary_descriptor)) %>% 
  mutate(boundary_descriptor=fct_relevel(boundary_descriptor, "Control farm", "Bare fence", "Old", "One year old", "Two year old" )) %>%
  mutate(boundary_alt=fct_relevel(boundary_alt, "Control farm", "Bare fence", "Old", "New"))
```

```{r}
save(pc_pol, file="Cleaned_datasets/pc_pollinator_data_cleaned.rda")
write_csv(pc_pol, file="Cleaned_datasets/pc_pollinator_data_cleaned.csv")
```